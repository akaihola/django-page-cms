{% extends "admin/base_site.html" %}
{% load adminmedia admin_list i18n pages %}
{% block title %}List of pages{% endblock %}
{% block stylesheet %}{% admin_media_prefix %}css/changelists.css{% endblock %}
{% block bodyclass %}change-list{% endblock %}

{% if not is_popup %}{% block breadcrumbs %}
    <div class="breadcrumbs">
    <a href="../../">{% trans "Home" %}</a> &rsaquo; 
    <a href="../">{{ app_label|capfirst|escape }}</a> &rsaquo; {{ opts.verbose_name_plural|capfirst|escape }}
    </div>
{% endblock %}{% endif %}

{% block coltype %}flex{% endblock %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}css/rte.css" />
<script type="text/javascript" src="http://jqueryjs.googlecode.com/files/jquery-1.2.6.min.js" /></script>
{% endblock %}
{% block extrastyle %}
<style>
.move-target-container{
    padding-left:2em;
}
.move-target-container a{
    font-weight:bold;
    font-size:16px;
    line-height:9px;
    padding:0 3px;
}
.move-target-container a.first-child{
    font-weight:normal;
}

tr{
    padding-left:1.5em;
}

.table-selected tr {
    background:#ffffd0;
}

tr.selected {
    background:#ffb;
}

table tr.target {
    background:#fff;
}

</style>
{% endblock %}

{% block content_title %}<h1>{% trans "Select" %} {{ name }} {% trans "to change" %}</h1>{% endblock %}

{% block content %}
<div id="content-main">

{% if has_add_permission %}
<ul class="object-tools"><li><a href="add/" class="addlink">{% trans "Add" %} {{ name }}</a></li></ul>
{% endif %}

<div class="module" id="changelist">

{% include "pages/change_list_table.html" %}

</div>
</div>
</div>

<script type="text/javascript">
    if(window.$) {
        $(document).ready(function() {
            var selected_page = false;
            var action = false;
            $('#changelist').click(function(e) {
                var jtarget = $(e.target);
                
                if(jtarget.hasClass("move")) {
                    var page_id = e.target.id.split("move-link-")[1];
                    selected_page = page_id;
                    action = "move";
                    $("#changelist table").removeClass("table-selected");
                    $('tr').removeClass("selected").removeClass("target");
                    $('#page-row-'+page_id).addClass("selected");
                    $.get("/admin/pages/page/"+page_id+"/valid-targets-list/", {}, function(html) {
                        var ids = html.split(",");
                        var css = "#move-target-"+ids.join(",#move-target-");
                        $('.move-target-container').hide();
                        $(css).show();
                        var css = "#page-row-"+ids.join(",#page-row-");
                        $(css).addClass("target");
                        $("#changelist table").addClass("table-selected");
                    });
                    return false;
                }
                
                if(jtarget.hasClass("add")) {
                    $("tr").removeClass("target");
                    $("#changelist table").removeClass("table-selected");
                    var page_id = e.target.id.split("add-link-")[1];
                    selected_page = page_id;
                    action = "add";
                    $('tr').removeClass("selected");
                    $('#page-row-'+page_id).addClass("selected");
                    $('.move-target-container').hide();
                    $('#move-target-'+page_id).show();
                    return false;
                }
                
                if(jtarget.hasClass("move-target")) {
                    if(jtarget.hasClass("left"))
                        var position = "left";
                    if(jtarget.hasClass("right"))
                        var position = "right";
                    if(jtarget.hasClass("first-child"))
                        var position = "first-child";
                    var target_id = e.target.parentNode.id.split("move-target-")[1];
                    if(action=="move") {
                        $.post("/admin/pages/page/"+selected_page+"/move_page/", {
                                position:position,
                                target:target_id
                            },
                            function(html) {
                                $('#changelist').html(html);
                                $('#page-row-'+selected_page).addClass("selected");
                            }
                        );
                        $('.move-target-container').hide();
                    }
                    if(action=="add") {
                        window.location.href += 'add/?target='+target_id+'&position='+position;
                    }
                    //selected_page = false;
                    return false;
                }
            });
        });
    }
</script>

{% endblock %}